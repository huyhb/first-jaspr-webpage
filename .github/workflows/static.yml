name: Deploy Jaspr to Cloudflare Pages

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1.3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2

      - name: Build Jaspr
        run: |
          dart pub global activate jaspr_cli
          jaspr build --verbose

      - name: Add _redirects file for SPA routing
        run: |
          mkdir -p build/jaspr
          echo '/*    /index.html    200' > build/jaspr/_redirects

      - name: Deploy to deploy branch (for Cloudflare Pages)
        run: |
          git config user.name "huyhb"
          git config user.email "huyhbs@github.com"

          # Tạo thư mục tạm chứa build
          mkdir temp-deploy
          cp -r build/jaspr/* temp-deploy/

          # Checkout nhánh deploy (orphan branch)
          git fetch origin
          git checkout --orphan deploy
          git rm -rf .

          # Copy build vào gốc repo
          cp -r temp-deploy/* .

          git add .
          git commit -m "Deploy to Cloudflare Pages"
          git push origin deploy --force
